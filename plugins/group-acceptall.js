const { cmd } = require('../command');

// Command to list all pending group join requests
cmd({
    pattern: "requestlist",
    desc: "Shows pending group join requests",
    category: "group",
    react: "ğŸ“‹",
    filename: __filename
},
async (conn, mek, m, { from, quoted, body, isCmd, command, args, q, isGroup, sender, senderNumber, botNumber2, botNumber, pushname, isMe, isOwner, groupMetadata, groupName, participants, groupAdmins, isBotAdmins, isAdmins, reply }) => {
    try {
        await conn.sendMessage(from, {
            react: { text: 'â³', key: m.key }
        });

        if (!isGroup) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ á´›ÊœÉªs á´„á´á´á´á´€É´á´… á´„á´€É´ á´É´ÊŸÊ Ê™á´‡ á´œsá´‡á´… ÉªÉ´ É¢Ê€á´á´œá´˜s.");
        }
        if (!isAdmins) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ á´É´ÊŸÊ É¢Ê€á´á´œá´˜ á´€á´…á´ÉªÉ´s á´„á´€É´ á´œsá´‡ á´›ÊœÉªs á´„á´á´á´á´€É´á´….");
        }
        if (!isBotAdmins) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ Éª É´á´‡á´‡á´… á´›á´ Ê™á´‡ á´€É´ á´€á´…á´ÉªÉ´ á´›á´ á´ Éªá´‡á´¡ á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s.");
        }

        const requests = await conn.groupRequestParticipantsList(from);
        
        if (requests.length === 0) {
            await conn.sendMessage(from, {
                react: { text: 'â„¹ï¸', key: m.key }
            });
            return reply("â„¹ï¸ É´á´ á´˜á´‡É´á´…ÉªÉ´É¢ á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s.");
        }

        let text = `ğŸ“‹ *á´˜á´‡É´á´…ÉªÉ´É¢ á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s (${requests.length})*\n\n`;
        requests.forEach((user, i) => {
            text += `${i+1}. @${user.jid.split('@')[0]}\n`;
        });

        await conn.sendMessage(from, {
            react: { text: 'âœ…', key: m.key }
        });
        return reply(text, { mentions: requests.map(u => u.jid) });
    } catch (error) {
        console.error("Request list error:", error);
        await conn.sendMessage(from, {
            react: { text: 'âŒ', key: m.key }
        });
        return reply("âŒ Failed to fetch join requests.");
    }
});

// Command to accept all pending join requests
cmd({
    pattern: "acceptall",
    desc: "Accepts all pending group join requests",
    category: "group",
    react: "âœ…",
    filename: __filename
},
async (conn, mek, m, { from, quoted, body, isCmd, command, args, q, isGroup, sender, senderNumber, botNumber2, botNumber, pushname, isMe, isOwner, groupMetadata, groupName, participants, groupAdmins, isBotAdmins, isAdmins, reply }) => {
    try {
        await conn.sendMessage(from, {
            react: { text: 'â³', key: m.key }
        });

        if (!isGroup) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ á´›ÊœÉªs á´„á´á´á´á´€É´á´… á´„á´€É´ á´É´ÊŸÊ Ê™á´‡ á´œsá´‡á´… ÉªÉ´ É¢Ê€á´á´œá´˜s.");
        }
        if (!isAdmins) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ á´É´ÊŸÊ É¢Ê€á´á´œá´˜ á´€á´…á´ÉªÉ´s á´„á´€É´ á´œsá´‡ á´›ÊœÉªs á´„á´á´á´á´€É´á´….");
        }
        if (!isBotAdmins) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ Éª É´á´‡á´‡á´… á´›á´ Ê™á´‡ á´€É´ á´€á´…á´ÉªÉ´ á´›á´ á´€á´„á´„á´‡á´˜á´› á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s.");
        }

        const requests = await conn.groupRequestParticipantsList(from);
        
        if (requests.length === 0) {
            await conn.sendMessage(from, {
                react: { text: 'â„¹ï¸', key: m.key }
            });
            return reply("â„¹ï¸ É´á´ á´˜á´‡É´á´…ÉªÉ´É¢ á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s á´›á´ á´€á´„á´„á´‡á´˜á´›.");
        }

        const jids = requests.map(u => u.jid);
        await conn.groupRequestParticipantsUpdate(from, jids, "approve");
        
        await conn.sendMessage(from, {
            react: { text: 'ğŸ‘', key: m.key }
        });
        return reply(`âœ… sá´œá´„á´„á´‡ssÒ“á´œÊŸÊŸÊ á´€á´„á´„á´‡á´˜á´›á´‡á´… ${requests.length} á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s.`);
    } catch (error) {
        console.error("Accept all error:", error);
        await conn.sendMessage(from, {
            react: { text: 'âŒ', key: m.key }
        });
        return reply("âŒ Failed to accept join requests.");
    }
});

// Command to reject all pending join requests
cmd({
    pattern: "rejectall",
    desc: "Rejects all pending group join requests",
    category: "group",
    react: "âŒ",
    filename: __filename
},
async (conn, mek, m, { from, quoted, body, isCmd, command, args, q, isGroup, sender, senderNumber, botNumber2, botNumber, pushname, isMe, isOwner, groupMetadata, groupName, participants, groupAdmins, isBotAdmins, isAdmins, reply }) => {
    try {
        await conn.sendMessage(from, {
            react: { text: 'â³', key: m.key }
        });

        if (!isGroup) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ á´›ÊœÉªs á´„á´á´á´á´€É´á´… á´„á´€É´ á´É´ÊŸÊ Ê™á´‡ á´œsá´‡á´… ÉªÉ´ É¢Ê€á´á´œá´˜s.");
        }
        if (!isAdmins) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ á´É´ÊŸÊ É¢Ê€á´á´œá´˜ á´€á´…á´ÉªÉ´s á´„á´€É´ á´œsá´‡ á´›ÊœÉªs á´„á´á´á´á´€É´á´….");
        }
        if (!isBotAdmins) {
            await conn.sendMessage(from, {
                react: { text: 'âŒ', key: m.key }
            });
            return reply("âŒ I É´á´‡á´‡á´… á´›á´ Ê™á´‡ á´€É´ á´€á´…á´ÉªÉ´ á´›á´ Ê€á´‡á´Šá´‡á´„á´› á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s.");
        }

        const requests = await conn.groupRequestParticipantsList(from);
        
        if (requests.length === 0) {
            await conn.sendMessage(from, {
                react: { text: 'â„¹ï¸', key: m.key }
            });
            return reply("â„¹ï¸ É´á´ á´˜á´‡É´á´…ÉªÉ´É¢ Ç« á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s á´›á´ Ê€á´‡á´Šá´‡á´„á´›.");
        }

        const jids = requests.map(u => u.jid);
        await conn.groupRequestParticipantsUpdate(from, jids, "reject");
        
        await conn.sendMessage(from, {
            react: { text: 'ğŸ‘', key: m.key }
        });
        return reply(`âœ… sá´œá´„á´„á´‡ssÒ“á´œÊŸÊŸÊ Ê€á´‡á´Šá´‡á´„á´›á´‡á´… ${requests.length} á´Šá´ÉªÉ´ Ê€á´‡Ç«á´œá´‡sá´›s.`);
    } catch (error) {
        console.error("Reject all error:", error);
        await conn.sendMessage(from, {
            react: { text: 'âŒ', key: m.key }
        });
        return reply("âŒ Failed to reject join requests.");
    }
});
